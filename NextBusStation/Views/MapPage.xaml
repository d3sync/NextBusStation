<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:NextBusStation.ViewModels"
             xmlns:models="clr-namespace:NextBusStation.Models"
             x:Class="NextBusStation.Views.MapPage"
             x:DataType="vm:MapViewModel"
             Title="Nearby Stops"
             BackgroundColor="{StaticResource Background}">
    
    <Grid RowDefinitions="Auto,Auto,*,Auto">
        <!-- Status Bar -->
        <Frame Grid.Row="0" 
               BackgroundColor="{StaticResource Primary}"
               Padding="15"
               CornerRadius="0"
               HasShadow="True">
            <Grid ColumnDefinitions="*,Auto">
                <Label Text="{Binding StatusMessage}"
                       TextColor="{StaticResource TextOnPrimary}"
                       VerticalOptions="Center"
                       FontSize="14"/>
                <ActivityIndicator Grid.Column="1"
                                 IsRunning="{Binding IsLoading}"
                                 IsVisible="{Binding IsLoading}"
                                 Color="{StaticResource TextOnPrimary}"/>
            </Grid>
        </Frame>
        
        <!-- Test Mode Banner -->
        <Frame Grid.Row="1"
               Margin="10,10,10,0"
               Padding="15"
               CornerRadius="10"
               BackgroundColor="{StaticResource WarningLight}"
               IsVisible="{Binding UseTestLocation}"
               BorderColor="{StaticResource Warning}"
               HasShadow="True">
            <Grid ColumnDefinitions="Auto,*">
                <Frame Grid.Column="0"
                       Padding="8"
                       CornerRadius="20"
                       BackgroundColor="{StaticResource Warning}"
                       HasShadow="False"
                       VerticalOptions="Center"
                       Margin="0,0,12,0">
                    <Label Text="TEST"
                           FontSize="12"
                           FontAttributes="Bold"
                           TextColor="{StaticResource TextOnPrimary}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
                </Frame>
                <StackLayout Grid.Column="1" VerticalOptions="Center">
                    <Label Text="TEST MODE ACTIVE"
                           FontAttributes="Bold"
                           TextColor="{StaticResource TextPrimary}"
                           FontSize="14"/>
                    <Label Text="Using Athens, Greece coordinates"
                           FontSize="12"
                           TextColor="{StaticResource TextSecondary}"/>
                </StackLayout>
            </Grid>
        </Frame>
        
        <!-- Map View or Stops List -->
        <Grid Grid.Row="2">
            <!-- OpenStreetMap WebView -->
            <WebView x:Name="MapWebView"
                     IsVisible="{Binding ShowMap}"
                     Margin="10"/>
            
            <!-- Stops List -->
            <CollectionView ItemsSource="{Binding NearbyStops}"
                           SelectionMode="None"
                           IsVisible="{Binding ShowMap, Converter={StaticResource InvertedBoolConverter}}"
                           Margin="10">
                <CollectionView.EmptyView>
                    <StackLayout Padding="20"
                               VerticalOptions="Center">
                        <Frame Padding="30"
                               CornerRadius="60"
                               BackgroundColor="{StaticResource Gray100}"
                               HasShadow="False"
                               HorizontalOptions="Center"
                               Margin="0,0,0,20">
                            <Label Text="●"
                                   FontSize="68"
                                   TextColor="{StaticResource Primary}"
                                   HorizontalOptions="Center"/>
                        </Frame>
                        <Label Text="No nearby stops found"
                               HorizontalOptions="Center"
                               FontSize="18"
                               TextColor="{StaticResource TextPrimary}"
                               FontAttributes="Bold"
                               Margin="0,0,0,5"/>
                        <Label Text="Tap 'Find Stops' or enable Test Mode"
                               HorizontalOptions="Center"
                               FontSize="14"
                               TextColor="{StaticResource TextSecondary}"
                               Margin="0,0,0,20"/>
                        <Button Text="Enable Test Mode (Athens)"
                                Command="{Binding ToggleTestModeCommand}"
                                IsVisible="{Binding UseTestLocation, Converter={StaticResource InvertedBoolConverter}}"
                                BackgroundColor="{StaticResource Warning}"
                                TextColor="{StaticResource TextOnPrimary}"
                                HorizontalOptions="Center"
                                CornerRadius="25"
                                Padding="30,12"
                                FontSize="14"
                                FontAttributes="Bold"/>
                    </StackLayout>
                </CollectionView.EmptyView>
                
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:BusStop">
                        <Frame Margin="0,0,0,12"
                               Padding="15"
                               CornerRadius="12"
                               BackgroundColor="{StaticResource Surface}"
                               BorderColor="{StaticResource CardBorder}"
                               HasShadow="True">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer 
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MapViewModel}}, Path=SelectStopCommand}"
                                    CommandParameter="{Binding .}"/>
                            </Frame.GestureRecognizers>
                            
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="6">
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="{Binding StopDescrEng}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource TextPrimary}"/>
                                
                                <Label Grid.Row="1" Grid.Column="0"
                                       Text="{Binding StopDescr}"
                                       FontSize="14"
                                       TextColor="{StaticResource TextSecondary}"/>
                                
                                <Label Grid.Row="2" Grid.Column="0"
                                       Text="{Binding StopCode, StringFormat='Stop Code: {0}'}"
                                       FontSize="12"
                                       TextColor="{StaticResource TextSecondary}"/>
                                
                                <Frame Grid.Row="3" Grid.Column="0"
                                       Padding="8,4"
                                       CornerRadius="6"
                                       BackgroundColor="{StaticResource Info}"
                                       HasShadow="False"
                                       HorizontalOptions="Start"
                                       Margin="0,4,0,0">
                                    <Label FontSize="12"
                                           TextColor="{StaticResource TextOnPrimary}"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="● " FontFamily=""/>
                                                <Span Text="{Binding Distance, StringFormat='{0:F0}m away'}"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </Frame>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>
        
        <!-- Action Buttons -->
        <Grid Grid.Row="3" 
              ColumnDefinitions="*,*,Auto" 
              Padding="10" 
              ColumnSpacing="10"
              BackgroundColor="{StaticResource Background}">
            <Button Grid.Column="0"
                    Text="Find Stops"
                    Command="{Binding LoadNearbyStopsCommand}"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="{StaticResource TextOnPrimary}"
                    CornerRadius="25"
                    FontSize="14"
                    FontAttributes="Bold"
                    Padding="0,15"
                    HeightRequest="50"/>
            <Button Grid.Column="1"
                    Text="{Binding ShowMap, Converter={StaticResource MapViewToggleConverter}}"
                    Command="{Binding ToggleMapViewCommand}"
                    BackgroundColor="{StaticResource Info}"
                    TextColor="{StaticResource TextOnPrimary}"
                    CornerRadius="25"
                    FontSize="14"
                    FontAttributes="Bold"
                    Padding="0,15"
                    HeightRequest="50"
                    IsEnabled="{Binding NearbyStops.Count, Converter={StaticResource HasItemsConverter}}"/>
            <Button Grid.Column="2"
                    Text="{Binding UseTestLocation, Converter={StaticResource TestModeButtonConverter}}"
                    Command="{Binding ToggleTestModeCommand}"
                    BackgroundColor="{Binding UseTestLocation, Converter={StaticResource TestModeColorConverter}}"
                    TextColor="{StaticResource TextOnPrimary}"
                    CornerRadius="25"
                    Padding="20,0"
                    FontSize="14"
                    FontAttributes="Bold"
                    HeightRequest="50"/>
        </Grid>
    </Grid>
</ContentPage>
